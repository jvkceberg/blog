---
import Icon from '@/components/Icon';

interface Props {
  name: string,
  class?: string,
  size?: number
}

const {
  name,
  class: className,
  size = 10,
} = Astro.props;

let labelClass = "d-swap d-swap-rotate";

if (className !== 'undefined') {
  labelClass += ` ${className}`
}
---

<label class={labelClass}>
  <span class="hidden">Theme Changer</span>

  <!-- this hidden checkbox controls the state -->
  <input type="checkbox" name={name} class="d-theme-controller" value="theme-control" aria-label="Theme Changer"/>

  <script is:inline>
    (function() {
      const savedTheme = localStorage.getItem('theme-preference');
      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'mocha' : 'latte';
      const theme = savedTheme || systemTheme;
      document.documentElement.setAttribute('data-theme', theme);
      
      // input 요소를 찾아 체크 상태를 즉시 변경
      const controls = document.querySelectorAll('.d-theme-controller');
      controls.forEach(control => {
        control.checked = (theme === 'mocha');
      });
    })();
  </script>

  <Icon name="tabler:sun" class=`d-swap-off h-${size} w-${size} fill-current`/>
  <Icon name="tabler:moon" class=`d-swap-on h-${size} w-${size} fill-current`/>
</label>

<script>
  const THEME_KEY = 'theme-preference';

  const syncAllToggles = (isDark: boolean) => {
    const theme = isDark ? 'mocha' : 'latte';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);

    const allToggles = document.querySelectorAll('.d-theme-controller') as NodeListOf<HTMLInputElement>;
    allToggles.forEach(input => {
      input.checked = isDark;
    });
  };

  const handleToggle = (e: Event) => {
    const input = e.target as HTMLInputElement;
    syncAllToggles(input.checked);
  };

  const setup = () => {
    const allToggles = document.querySelectorAll('.d-theme-controller');
    allToggles.forEach(toggle => {
      toggle.removeEventListener('change', handleToggle);
      toggle.addEventListener('change', handleToggle);
    });
  };

  setup();
  document.addEventListener('astro:after-swap', setup);
</script>